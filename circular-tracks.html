<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Circular Tracks ‚Äì Time & Distance</title>
  <meta name="description" content="Simulate drivers on a circular track: adjust length, add drivers, set speeds & directions, and see meeting points and times.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --f1-red:#E10600;
      --bg1:#2E2E2E; --bg2:#3A3A3A;
      --text:#ffffff; --link:#00BFFF;
    }
    *{box-sizing:border-box}
    body{
      margin:0;color:var(--text);
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        linear-gradient(135deg, rgba(255,255,255,.06) 0 2px, transparent 2px 20px) 0 0/28px 28px,
        repeating-linear-gradient(45deg, var(--bg1) 0 16px, var(--bg2) 16px 32px);
    }
    header{position:sticky;top:0;z-index:5;background:rgba(20,20,20,.85);backdrop-filter:blur(6px);border-bottom:1px solid #555}
    .wrap{max-width:1200px;margin:0 auto;padding:16px 20px;display:flex;align-items:center;gap:14px}
    .logo{width:40px;height:40px;border-radius:10px;background:var(--f1-red);display:grid;place-items:center;box-shadow:0 8px 20px rgba(225,6,0,.35)}
    h1{margin:0;font-family:'Russo One',sans-serif;font-size:24px}
    a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
    main{max-width:1200px;margin:0 auto;padding:18px;display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
    @media(max-width:1000px){main{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,#2f2f2f,#232323);border:1px solid #666;border-radius:14px;padding:14px}
    .card h2{font-family:'Russo One',sans-serif;margin:0 0 8px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .controls input[type="number"], .controls select{width:120px;padding:8px;border-radius:10px;border:1px solid #aaa;background:#101010;color:#fff}
    .btn{border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer;color:#fff}
    .primary{background:linear-gradient(180deg,var(--f1-red),#b30a06)}
    .ghost{background:linear-gradient(180deg,#3a3a3a,#222)}
    /* Responsive sim area ‚Äî no clipping */
    .sim{display:grid;grid-template-rows:auto 1fr auto;gap:10px}
    #canvasWrap{
      width:100%; aspect-ratio:1 / 1; /* stays square */
      display:grid; place-items:center; background:#1a1a1a;
      border-radius:12px; border:1px dashed #777; position:relative; overflow:visible;
    }
    canvas{width:100%; height:100%; /* fill wrapper */}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .list{display:flex;flex-direction:column;gap:10px;max-height:560px;overflow:auto}
    .runner{display:grid;grid-template-columns:auto 1fr auto auto;gap:8px;align-items:center;padding:10px;border:1px solid #777;border-radius:12px;background:linear-gradient(180deg,#313131,#262626)}
    .dot{width:14px;height:14px;border-radius:50%}
    .small{font-size:12px;color:#eee}
    .toggle{cursor:pointer;border:2px solid #fff;color:#fff;border-radius:999px;padding:7px 12px;background:#252525;font-weight:800}
    .pill{display:inline-block;border:1px solid #999;border-radius:999px;padding:6px 10px;background:#111;font-weight:700}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    footer{max-width:1200px;margin:18px auto 28px;padding:0 18px;color:#fff;display:flex;justify-content:space-between;flex-wrap:wrap}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="logo" aria-hidden="true">
        <svg width="26" height="26" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 40h40c7 0 12-5 12-12 0-7-5-12-12-12H28" stroke="#fff" stroke-width="6" stroke-linecap="round"/>
          <path d="M6 24h22" stroke="#000" stroke-width="6" stroke-linecap="round"/>
        </svg>
      </div>
      <div>
        <h1>Circular Tracks</h1>
        <div class="small">Simulate drivers on a circular track ‚Ä¢ find meeting points and times</div>
      </div>
      <div style="margin-left:auto">
        <a class="pill" href="index.html">üèÅ Home</a>
      </div>
    </div>
  </header>

  <main>
    <section class="card sim">
      <div class="controls">
        <label>Track length (m):
          <input type="number" id="trackLen" min="50" step="10" value="400">
        </label>
        <label>Speed unit:
          <select id="unitSelect">
            <option value="mps">m/s</option>
            <option value="kmph">km/h</option>
          </select>
        </label>
        <button id="startBtn" class="btn primary">‚ñ∂ Start</button>
        <button id="pauseBtn" class="btn ghost">‚è∏ Pause</button>
        <button id="resetBtn" class="btn ghost">‚Ü∫ Reset</button>
      </div>
      <div id="canvasWrap">
        <canvas id="trackCanvas" width="800" height="800"></canvas>
        <div class="small" style="position:absolute;bottom:10px;left:10px;opacity:.9;">
          Tip: Click a driver to select, then drag clockwise/counterclockwise to set direction.
        </div>
      </div>
      <div class="row">
        <div class="pill">Distinct meeting points observed: <span id="meetCount" class="mono">0</span></div>
        <div class="pill">Next pair to meet: <span id="nextMeet" class="mono">‚Äì</span></div>
      </div>
    </section>

    <aside class="card">
      <h2>Drivers</h2>
      <div class="row" style="margin-bottom:10px">
        <button id="addBtn" class="btn primary">+ Add driver</button>
        <button id="clearMeetBtn" class="btn ghost">üßπ Clear meeting markers</button>
      </div>
      <div class="list" id="driverList"></div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin-top:0">Calculators</h3>
        <div class="row" style="gap:12px;flex-wrap:wrap">
          <div class="pill">First time <b>all meet at any point</b>: <span id="allAny" class="mono">‚Äì</span></div>
          <div class="pill">First time <b>all at start</b>: <span id="allStart" class="mono">‚Äì</span></div>
        </div>
        <div class="small" style="margin-top:8px;color:#eaeaea">
          ‚Ä¢ All meet at any point = LCM of pairwise meeting times w.r.t. a reference driver (handles CW/CCW).<br>
          ‚Ä¢ All at start = LCM of individual lap times <span class="mono">(L / |v|)</span> using exact fractions (no rounding).
        </div>
      </div>
    </aside>
  </main>

  <footer>
    <div><span class="pill">Made by IMS Gujarat</span></div>
    <div>¬© 2025 Time &amp; Distance Simulations</div>
  </footer>

  <script>
    // ====== Exact fraction helpers ======
    function gcdInt(a,b){ a=Math.abs(a); b=Math.abs(b); while(b!==0){ const t=b; b=a%b; a=t; } return a; }
    function lcmInt(a,b){ return Math.abs(a/gcdInt(a,b)*b); }
    function toFraction(x){
      // Convert finite decimal to fraction n/d exactly by using string length
      const s = String(x);
      if(!s.includes('.')) return {n: Math.trunc(x), d: 1};
      const parts = s.split('.');
      const decimals = parts[1].length;
      const d = Math.pow(10, decimals);
      const n = Math.round(parseFloat(s) * d);
      const g = gcdInt(n,d);
      return {n: n/g, d: d/g};
    }
    function multiplyFrac(a,b){ return reduceFrac({n:a.n*b.n, d:a.d*b.d}); }
    function divideFrac(a,b){ return reduceFrac({n:a.n*b.d, d:a.d*b.n}); }
    function reduceFrac(fr){ const g=gcdInt(fr.n,fr.d); return {n:fr.n/g, d:fr.d/g}; }
    function fracToNumber(fr){ return fr.n / fr.d; }
    function lcmRationals(fracs){
      // LCM of rationals a_i/b_i (fracs reduced) = lcm(a_i) / gcd(b_i)
      if(fracs.length===0) return {n:0,d:1};
      let A = fracs[0].n, B = fracs[0].d;
      for(let i=1;i<fracs.length;i++){
        A = lcmInt(A, fracs[i].n);
        B = gcdInt(B, fracs[i].d);
      }
      return reduceFrac({n:A,d:B});
    }

    // ====== State ======
    const colors = ["#2BD67B","#00E0FF","#FFC400","#FF5DA2","#B084FF","#FF7A00","#9DFF00","#00FFC6"];
    const drivers = [];
    let nextId=1, L=400, running=false, lastTs=null, unit='mps';
    let distinctMeetPositions=[];
    // Canvas
    const canvas=document.getElementById('trackCanvas'), ctx=canvas.getContext('2d');
    let W=canvas.width, H=canvas.height, cx=W/2, cy=H/2, R_track=Math.min(W,H)/2-40;

    // DOM
    const trackLenInput=document.getElementById('trackLen');
    const unitSelect=document.getElementById('unitSelect');
    const startBtn=document.getElementById('startBtn');
    const pauseBtn=document.getElementById('pauseBtn');
    const resetBtn=document.getElementById('resetBtn');
    const addBtn=document.getElementById('addBtn');
    const clearMeetBtn=document.getElementById('clearMeetBtn');
    const driverList=document.getElementById('driverList');
    const meetCount=document.getElementById('meetCount');
    const nextMeet=document.getElementById('nextMeet');
    const allStart=document.getElementById('allStart');
    const allAny=document.getElementById('allAny');

    // Resize canvas to wrapper (keeps full track visible)
    const wrap = document.getElementById('canvasWrap');
    function resizeCanvas(){
      const rect = wrap.getBoundingClientRect();
      const size = Math.min(rect.width, rect.height);
      canvas.width = canvas.height = Math.floor(size*2); // high DPI
      W=canvas.width; H=canvas.height; cx=W/2; cy=H/2; R_track=Math.min(W,H)/2-40;
      draw();
    }
    new ResizeObserver(resizeCanvas).observe(wrap);

    // Drivers
    function addDriver(v_mps=6, dir=+1){
      const d={id:nextId++,color:colors[(nextId-2)%colors.length],v_mps,dir,theta:0,selected:false};
      drivers.push(d); renderDriverList(); recomputeAggregates(); return d;
    }
    function removeDriver(id){
      const i=drivers.findIndex(d=>d.id===id); if(i>=0){drivers.splice(i,1); renderDriverList(); recomputeAggregates();}
    }
    function formatSpeed(d){ return unit==='mps'? d.v_mps.toFixed(2) : (d.v_mps*3.6).toFixed(1); }
    function parseSpeed(val){ const x=parseFloat(val||'0'); return unit==='mps'? x : x/3.6; }

    function renderDriverList(){
      driverList.innerHTML="";
      drivers.forEach(d=>{
        const row=document.createElement('div'); row.className='runner';
        row.innerHTML=`
          <div class="dot" style="background:${d.color}"></div>
          <div>
            <div><b>Driver ${d.id}</b> ¬∑ <span class="mono">${d.dir>0?'CW':'CCW'}</span></div>
            <div class="small">Speed (${unit==='mps'?'m/s':'km/h'}):</div>
          </div>
          <input type="number" min="0" step="${unit==='mps'?'0.1':'0.5'}" value="${formatSpeed(d)}" style="width:110px;background:#111;color:#fff;border:1px solid #fff;border-radius:10px;padding:8px" />
          <button class="toggle">${d.dir>0?'‚ü≥ CW':'‚ü≤ CCW'}</button>
        `;
        const speedInput=row.children[2]; const toggleBtn=row.children[3];
        speedInput.addEventListener('input',e=>{ d.v_mps=Math.max(0,parseSpeed(e.target.value)); recomputeAggregates(); });
        toggleBtn.addEventListener('click',()=>{ d.dir*=-1; renderDriverList(); recomputeAggregates(); });
        driverList.appendChild(row);
      });
      if(drivers.length>2){
        drivers.forEach((d,idx)=>{
          const row=driverList.children[idx]; const btn=document.createElement('button');
          btn.className='toggle'; btn.textContent='üóë Remove'; btn.addEventListener('click',()=>removeDriver(d.id));
          row.appendChild(btn);
        });
      }
    }

    // Calculators
    function recomputeAllStartTime(){
      if(drivers.length===0){ allStart.textContent='‚Äì'; return; }
      // tau_i = L / v_i (seconds). Represent v_i as fraction; tau_i = L * (den/num)
      const taus = [];
      for(const d of drivers){
        if(d.v_mps<=0){ allStart.textContent='‚Äì (set speeds > 0)'; return; }
        const vfr = toFraction(d.v_mps); // num/den
        // tau = L * den / num
        let tfr = reduceFrac({n: L * vfr.d, d: vfr.n});
        taus.push(tfr);
      }
      const l = lcmRationals(taus); // fraction
      allStart.textContent = (fracToNumber(l)).toFixed(2) + ' s';
    }
    function recomputeAllMeetAnyPoint(){
      if(drivers.length<=1){ allAny.textContent = drivers.length===1 ? '0 s' : '‚Äì'; return; }
      const ref = drivers[0];
      const frs = [];
      for(let i=1;i<drivers.length;i++){
        const d = drivers[i];
        const rel = Math.abs(ref.dir*ref.v_mps - d.dir*d.v_mps);
        if(rel < 1e-12) continue;
        const rfr = toFraction(rel); // (m/s)
        // time = L / rel
        const tfr = reduceFrac({n: L * rfr.d, d: rfr.n});
        frs.push(tfr);
      }
      if(frs.length===0){ allAny.textContent='Always together'; return; }
      const l = lcmRationals(frs);
      allAny.textContent = (fracToNumber(l)).toFixed(2) + ' s';
    }
    function computeNextPairMeet(){
      if(drivers.length<2){ nextMeet.textContent='‚Äì'; return; }
      let best=Infinity, pair=null;
      for(let i=0;i<drivers.length;i++){
        for(let j=i+1;j<drivers.length;j++){
          const a=drivers[i], b=drivers[j];
          const rel = Math.abs(a.dir*a.v_mps - b.dir*b.v_mps);
          const t = rel<1e-12 ? Infinity : L/rel;
          if(t<best){best=t; pair=[a.id,b.id];}
        }
      }
      nextMeet.textContent = best===Infinity ? '‚Äì' : `Drivers ${pair[0]} & ${pair[1]} in ${best.toFixed(2)} s`;
    }
    function recomputeAggregates(){ recomputeAllStartTime(); recomputeAllMeetAnyPoint(); computeNextPairMeet(); }

    // Meetings rendering
    let meetMarkers=[];
    function modL(x){ x%=L; if(x<0) x+=L; return x; }
    function recordMeetingAt(s){
      s = modL(s);
      const exists = distinctMeetPositions.some(p=> Math.abs(p-s)<1);
      if(!exists){ distinctMeetPositions.push(s); meetCount.textContent=String(distinctMeetPositions.length); }
    }

    // Draw
    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // track
      ctx.beginPath(); ctx.arc(cx,cy,R_track,0,Math.PI*2); ctx.lineWidth=14; ctx.strokeStyle="#3c3c3c"; ctx.stroke();
      // lane
      ctx.beginPath(); ctx.arc(cx,cy,R_track-18,0,Math.PI*2); ctx.setLineDash([8,10]); ctx.lineWidth=2; ctx.strokeStyle="#dcdcdc"; ctx.stroke(); ctx.setLineDash([]);
      // start line
      ctx.save(); ctx.translate(cx,cy); ctx.rotate(-Math.PI/2); ctx.beginPath(); ctx.moveTo(R_track-30,0); ctx.lineTo(R_track+10,0); ctx.lineWidth=4; ctx.strokeStyle="#fff"; ctx.stroke(); ctx.restore();
      // markers
      for(const m of meetMarkers){
        const ang = -Math.PI/2 + 2*Math.PI*(m.s/L);
        const x = cx + (R_track-6)*Math.cos(ang), y = cy + (R_track-6)*Math.sin(ang);
        ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fillStyle="#FFD54F"; ctx.fill();
      }
      // drivers
      for(const d of drivers){
        const ang = -Math.PI/2 + 2*Math.PI*d.theta;
        const x = cx + (R_track-6)*Math.cos(ang), y = cy + (R_track-6)*Math.sin(ang);
        ctx.beginPath(); ctx.arc(x,y,10,0,Math.PI*2); ctx.fillStyle=d.color; ctx.shadowColor=d.color; ctx.shadowBlur=d.selected?20:8; ctx.fill(); ctx.shadowBlur=0;
        ctx.beginPath(); const dirAng= ang + (d.dir>0?+0.3:-0.3); ctx.moveTo(x,y); ctx.lineTo(x+18*Math.cos(dirAng), y+18*Math.sin(dirAng)); ctx.lineWidth=2; ctx.strokeStyle="#fff"; ctx.stroke();
      }
    }

    // Loop
    function step(ts){
      if(!running){ draw(); return; }
      if(lastTs==null) lastTs=ts; const dt=(ts-lastTs)/1000; lastTs=ts;
      for(const d of drivers){
        const lapsPerSec = (d.dir*d.v_mps)/L;
        d.theta = (d.theta + lapsPerSec*dt) % 1; if(d.theta<0) d.theta+=1;
      }
      for(let i=0;i<drivers.length;i++){
        for(let j=i+1;j<drivers.length;j++){
          const a=drivers[i], b=drivers[j];
          const wa=(a.dir*a.v_mps)/L, wb=(b.dir*b.v_mps)/L;
          const relw=wa-wb; if(Math.abs(relw)<1e-10) continue;
          let delta0=a.theta-b.theta; delta0=((delta0+0.5)%1)-0.5;
          const tMeet = -delta0/relw;
          if(tMeet>0 && tMeet<=dt){
            const thetaMeet = (a.theta + wa*tMeet) % 1;
            const s = thetaMeet * L;
            meetMarkers.push({s}); recordMeetingAt(s);
          }
        }
      }
      draw(); requestAnimationFrame(step);
    }

    // Mouse
    let mouseDown=false, activeDriver=null, dragStart=0;
    function getCanvasXY(e){
      const rect=canvas.getBoundingClientRect();
      const scaleX = canvas.width/rect.width, scaleY = canvas.height/rect.height;
      return { x:(e.clientX-rect.left)*scaleX, y:(e.clientY-rect.top)*scaleY };
    }
    function angAt(x,y){ let a=Math.atan2(y-cy,x-cx); a=(a+Math.PI*2)%(Math.PI*2); return a; }
    canvas.addEventListener('mousedown',e=>{
      const {x,y}=getCanvasXY(e); activeDriver=null;
      for(const d of drivers){
        const ang=-Math.PI/2+2*Math.PI*d.theta; const px=cx+(R_track-6)*Math.cos(ang), py=cy+(R_track-6)*Math.sin(ang);
        const dist2=(x-px)*(x-px)+(y-py)*(y-py); if(dist2<=18*18){ activeDriver=d; break; }
      }
      if(activeDriver){ drivers.forEach(d=>d.selected=false); activeDriver.selected=true; mouseDown=true; dragStart=angAt(x,y); }
    });
    canvas.addEventListener('mousemove',e=>{
      if(!mouseDown||!activeDriver) return; const {x,y}=getCanvasXY(e); const now=angAt(x,y); const delta=now-dragStart;
      if(Math.abs(delta)>0.35){ activeDriver.dir = delta>0 ? +1 : -1; recomputeAggregates(); }
    });
    window.addEventListener('mouseup',()=>{ mouseDown=false; activeDriver=null; drivers.forEach(d=>d.selected=false); });

    // Controls
    document.getElementById('clearMeetBtn').addEventListener('click',()=>{ distinctMeetPositions=[]; meetMarkers=[]; meetCount.textContent='0'; draw(); });
    document.getElementById('addBtn').addEventListener('click',()=>{ addDriver(6+Math.random()*4,+1); });
    document.getElementById('resetBtn').addEventListener('click',()=>{
      running=false; lastTs=null; drivers.forEach(d=>d.theta=0); distinctMeetPositions=[]; meetMarkers=[]; meetCount.textContent='0'; recomputeAggregates(); draw();
    });
    document.getElementById('startBtn').addEventListener('click',()=>{ if(!running){ running=true; lastTs=null; requestAnimationFrame(step);} });
    document.getElementById('pauseBtn').addEventListener('click',()=> running=false);
    document.getElementById('trackLen').addEventListener('input',e=>{ L=Math.max(50,parseFloat(e.target.value||'400')); recomputeAggregates(); });
    document.getElementById('unitSelect').addEventListener('change',e=>{ unit=e.target.value; renderDriverList(); });

    // Init
    addDriver(6,+1); addDriver(8,+1); recomputeAggregates(); resizeCanvas(); requestAnimationFrame(step);
  </script>
</body>
</html>
